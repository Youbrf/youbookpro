(()=>{"use strict";var e,t={338:(e,t,s)=>{var r=s(795);t.H=r.createRoot,r.hydrateRoot},628:(e,t,s)=>{const r=window.wp.blocks,n=(window.wp.i18n,window.wp.blockEditor),o=window.React;var i=s(338);function a(e){return e.reduce(((e,t)=>{const s=t.category?.name||"Autres";return e[s]||(e[s]=[]),e[s].push(t),e}),{})}function l(e){const t=document.createElement("textarea");return t.innerHTML=e,t.value}function c(e){return`${Math.floor(e/60).toString().padStart(2,"0")}:${(e%60).toString().padStart(2,"0")}`}function d(e,t,s,r,n,o){const i=[];for(let e=s;e<=r-t;e+=n)i.push(e);const a=e.map((e=>{const t=function(e){const[t,s]=e.split(":").map(Number);return 60*t+s}(e.time);return{start:t,end:t+parseInt(e.duration)}})),l=new Date,d=o===l.toISOString().split("T")[0],u=60*l.getHours()+l.getMinutes();return i.filter((e=>{const s=e+t;return!(d&&e<=u||a.some((t=>e<t.end&&s>t.start)))})).map(c)}async function u(e){try{const t=await fetch(`/wp-json/youbookpro/v1/reservations?date=${e}`);return await t.json()}catch(e){return console.error("Erreur lors de la récupération des réservations :",e),[]}}const p=1080,h=window.ReactJSXRuntime,v=function({services:e,selectedServices:t,toggleService:s,error:r,onNextStep:n}){const o=0===e.length&&!r;return(0,h.jsxs)("div",{className:"services-section",children:[o?(0,h.jsx)("p",{children:"Chargement des services..."}):Object.entries(a(e)).map((([e,r])=>(0,h.jsxs)("div",{className:"category-block",children:[(0,h.jsx)("h4",{className:"category-title",children:l(e)}),(0,h.jsx)("table",{className:"category-table desktop-only",children:(0,h.jsx)("tbody",{children:r.map((e=>(0,h.jsxs)("tr",{children:[(0,h.jsx)("td",{children:l(e.title)}),(0,h.jsxs)("td",{children:[e.price," €"]}),(0,h.jsxs)("td",{children:[e.duration," min"]}),(0,h.jsx)("td",{children:(0,h.jsx)("button",{onClick:()=>s(e),children:t.find((t=>t.id===e.id))?"Retirer":"Sélectionner"})})]},e.id)))})}),(0,h.jsx)("div",{className:"mobile-only",children:r.map((e=>(0,h.jsxs)("div",{className:"mobile-service",children:[(0,h.jsx)("div",{className:"service-title",children:l(e.title)}),(0,h.jsxs)("div",{className:"service-info",children:[(0,h.jsxs)("div",{className:"left-info",children:[(0,h.jsxs)("span",{children:[e.price," €"]})," • ",(0,h.jsxs)("span",{children:[e.duration," min"]})]}),(0,h.jsx)("div",{className:"right-button",children:(0,h.jsx)("button",{onClick:()=>s(e),children:t.find((t=>t.id===e.id))?"Retirer":"Sélectionner"})})]})]},e.id)))})]},e))),r&&(0,h.jsx)("div",{className:"error-popup",children:r}),t.length>0&&(0,h.jsxs)("div",{className:"next-step-bar centered",children:[(0,h.jsxs)("div",{children:[(0,h.jsx)("strong",{children:t.length})," service(s) sélectionné(s) –",(0,h.jsxs)("strong",{children:[" ",t.reduce(((e,t)=>e+parseFloat(t.price)),0)," €"]})]}),(0,h.jsx)("button",{onClick:n,children:"Choisir un créneau →"})]})]})};function m(e,t){const s=new Date(e);return s.setDate(s.getDate()+t),s}const x=function({totalDuration:e,selectedDate:t,setSelectedDate:s,setAvailableSlots:r}){const[n,i]=(0,o.useState)(new Date),[a,l]=(0,o.useState)([]),[c,v]=(0,o.useState)([]),x=a.some((e=>(e=>{const t=new Date;return e.getDate()===t.getDate()&&e.getMonth()===t.getMonth()&&e.getFullYear()===t.getFullYear()})(e)));return(0,o.useEffect)((()=>{(async()=>{try{const t=(new Date).toISOString().split("T")[0],s=await fetch(`/wp-json/youbookpro/v1/reservations/from?from=${t}`),n=await s.json(),o={};n.forEach((e=>{o[e.date]||(o[e.date]=[]),o[e.date].push(e)}));const i=Object.entries(o).filter((([t,s])=>0===d(s,e,600,p,30,s.date).length)).map((([e])=>e)),a=[],l=new Date;for(let e=0;e<30;e++){const t=new Date(l);t.setDate(l.getDate()+e),0===t.getDay()&&a.push(t.toISOString().split("T")[0])}const c=Array.from(new Set([...i,...a]));v(c),c.includes(t)||r(d(await u(t),e,600,p,30,t))}catch(e){console.error("Erreur lors de la récupération des dates désactivées:",e)}})()}),[e]),(0,o.useEffect)((()=>{l(function(e){const t=[];for(let s=0;s<7;s++){const r=new Date(e);r.setDate(r.getDate()+s),t.push(r)}return t}(n))}),[n]),(0,o.useEffect)((()=>{const e=(new Date).toISOString().split("T")[0];s(e)}),[]),(0,h.jsxs)("div",{className:"week-selector",children:[(0,h.jsx)("button",{onClick:()=>i(m(n,-7)),disabled:x,style:{opacity:x?.3:1,cursor:x?"not-allowed":"pointer"},title:x?"Impossible de revenir avant cette semaine":"Semaine précédente",children:"<"}),(0,h.jsx)("div",{className:"week-days",children:a.map((n=>{const o=n.getDate(),i=n.toISOString().split("T")[0],a=t===i,l=0===n.getDay()||c.includes(i);return(0,h.jsx)("button",{disabled:l,className:"day-btn "+(l?"disabled":a?"selected":"normal"),onClick:()=>(async t=>{if(0===t.getDay())return;const n=t.toISOString().split("T")[0];c.includes(n)||(s(n),r(d(await u(n),e,600,p,30,n)))})(n),title:l?"Jour indisponible":"",children:o},i)}))}),(0,h.jsx)("button",{onClick:()=>i(m(n,7)),children:">"})]})},j=({selectedServices:e,totalDuration:t,selectedDate:s,setSelectedDate:r,availableSlots:n,setAvailableSlots:o,selectedSlot:i,setSelectedSlot:a,onNextStep:l,onPrevStep:c,error:d})=>(0,h.jsxs)("div",{className:"slots-section",children:[(0,h.jsx)("h3",{children:"Créneaux disponibles pour :"}),(0,h.jsx)("ul",{children:e.map((e=>(0,h.jsxs)("li",{children:[e.title," - ",e.duration," min"]},e.id)))}),(0,h.jsx)("h3",{children:"Choisissez un jour :"}),(0,h.jsx)(x,{setAvailableSlots:o,selectedDate:s,setSelectedDate:r,totalDuration:t}),s&&(0,h.jsxs)("div",{children:[(0,h.jsxs)("h4",{children:["Créneaux disponibles pour le ",s]}),n.length>0?(0,h.jsx)("div",{style:{display:"flex",flexDirection:"column",gap:"10px",marginTop:"10px"},children:n.map((e=>(0,h.jsx)("button",{className:"slot-btn-vertical "+(i===e?"selected":""),onClick:()=>a(e),children:e},e)))}):(0,h.jsx)("p",{children:"Aucun créneau disponible pour cette date."})]}),i&&(0,h.jsxs)("div",{className:"next-step-bar centered",children:[(0,h.jsxs)("div",{children:[(0,h.jsx)("strong",{children:"Créneau sélectionné :"})," ",i]}),(0,h.jsx)("button",{onClick:l,children:"Passer à l’étape suivante →"})]}),(0,h.jsx)("button",{onClick:c,children:"← Retour aux services"}),d&&(0,h.jsx)("div",{className:"error-popup",children:d})]}),S=function({selectedDate:e,selectedSlot:t,selectedServices:s,totalDuration:r,onSubmit:n,onPrevStep:i,error:a}){const[l,c]=(0,o.useState)(""),[d,u]=(0,o.useState)(""),[p,v]=(0,o.useState)(""),[m,x]=(0,o.useState)(""),[j,S]=(0,o.useState)(!1),[f,g]=(0,o.useState)(null),[b,y]=(0,o.useState)(!1);return(0,h.jsxs)("div",{className:"confirmation-section",children:[(0,h.jsx)("h3",{children:"Confirmation de la réservation"}),(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Date :"})," ",e]}),(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Heure :"})," ",t]}),(0,h.jsx)("ul",{children:s.map((e=>(0,h.jsxs)("li",{children:[e.title," – ",e.duration," min"]},e.id)))}),(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Durée totale :"})," ",r," min"]}),(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Montant total :"})," ",s.reduce(((e,t)=>e+parseFloat(t.price)),0)," €"]}),(0,h.jsxs)("form",{onSubmit:async o=>{if(o.preventDefault(),g(null),y(!1),!(l&&d&&p&&m?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(p)?(g(null),1):(g("Veuillez entrer une adresse email valide."),0):(g("Veuillez remplir tous les champs."),0)))return;S(!0);const i={first_name:l,last_name:d,email:p,phone:m,date:e,time:t,services:s.map((e=>e.id)),duration:r};try{await n(i),y(!0)}catch(e){console.error("Erreur de soumission du formulaire:",e),g(e.message||"Une erreur est survenue lors de la réservation."),y(!1)}finally{S(!1)}},children:[" ",(0,h.jsx)("input",{type:"text",placeholder:"Prénom",name:"first_name",value:l,onChange:e=>c(e.target.value),required:!0}),(0,h.jsx)("input",{type:"text",placeholder:"Nom",name:"last_name",value:d,onChange:e=>u(e.target.value),required:!0}),(0,h.jsx)("input",{type:"email",placeholder:"Email",name:"email",value:p,onChange:e=>v(e.target.value),required:!0}),(0,h.jsx)("input",{type:"tel",placeholder:"Téléphone",name:"phone",value:m,onChange:e=>x(e.target.value),required:!0}),j&&(0,h.jsx)("p",{children:"Traitement de votre réservation..."}),f&&(0,h.jsx)("div",{className:"error-popup",children:f}),b&&(0,h.jsx)("div",{className:"success-popup",children:"Réservation effectuée avec succès !"}),a&&!f&&(0,h.jsx)("div",{className:"error-popup",children:a}),(0,h.jsx)("button",{type:"submit",disabled:j||b,children:j?"Confirmation en cours...":b?"Réservé !":"Confirmer la réservation"})]}),(0,h.jsx)("button",{onClick:i,disabled:j,children:"← Retour au créneau"})]})};function f(){const[e,t]=(0,o.useState)(1),[s,r]=(0,o.useState)([]),[n,i]=(0,o.useState)([]),[a,l]=(0,o.useState)(!0),[c,d]=(0,o.useState)(null),[u,p]=(0,o.useState)(null),[m,x]=(0,o.useState)([]),[f,g]=(0,o.useState)([]),[b,y]=(0,o.useState)(null),[w,D]=(0,o.useState)([]),k=s.reduce(((e,t)=>e+parseInt(t.duration)),0);return(0,o.useEffect)((()=>{(async function(){const e=await fetch("/wp-json/youbookpro/v1/services");if(!e.ok)throw new Error("Erreur chargement services");return e.json()})().then(i).catch((e=>{console.error(e),d("Impossible de charger les services.")}))}),[]),(0,o.useEffect)((()=>{if(c){const e=setTimeout((()=>d(null)),5e3);return()=>clearTimeout(e)}}),[c]),(0,h.jsxs)("div",{className:"youbookpro-booking",children:[1===e&&(0,h.jsx)(v,{services:n,selectedServices:s,toggleService:e=>{r((t=>t.find((t=>t.id===e.id))?(d(null),t.filter((t=>t.id!==e.id))):t.length>=2?(d("Vous pouvez sélectionner jusqu'à 2 services maximum."),t):(d(null),[...t,e])))},error:c,onNextStep:()=>{s.length>0?(t(2),d(null)):d("Veuillez sélectionner au moins un service.")}}),2===e&&(0,h.jsx)(j,{selectedServices:s,totalDuration:k,selectedDate:u,setSelectedDate:p,reservations:f,availableSlots:m,setAvailableSlots:x,selectedSlot:b,setSelectedSlot:y,disabledDates:w,setDisabledDatesGlobal:D,onNextStep:()=>{b?(t(3),d(null)):d("Veuillez sélectionner un créneau horaire.")},onPrevStep:()=>{t(1),d(null)},error:c}),3===e&&(0,h.jsx)(S,{selectedDate:u,selectedSlot:b,selectedServices:s,totalDuration:k,onSubmit:async e=>{try{const s=await fetch("/wp-json/youbookpro/v1/reserve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok){const e=await s.json();throw new Error(e.message||"Erreur lors de la réservation")}const n=await s.json();return t(1),r([]),y(null),p(null),g([]),x([]),n}catch(e){throw console.error("Erreur lors de la réservation (dans BookingBlock) :",e),e}},onPrevStep:()=>{t(2),d(null)},error:c})]})}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("youbookpro-booking-root");e&&(0,i.H)(e).render((0,h.jsx)(f,{}))}));const g=f,b=JSON.parse('{"UU":"youbookpro/booking"}');(0,r.registerBlockType)(b.UU,{edit:function(){const e=(0,n.useBlockProps)();return(0,h.jsx)("div",{...e,children:(0,h.jsx)(g,{})})},save:function(){return null}})},795:e=>{e.exports=window.ReactDOM}},s={};function r(e){var n=s[e];if(void 0!==n)return n.exports;var o=s[e]={exports:{}};return t[e](o,o.exports,r),o.exports}r.m=t,e=[],r.O=(t,s,n,o)=>{if(!s){var i=1/0;for(d=0;d<e.length;d++){for(var[s,n,o]=e[d],a=!0,l=0;l<s.length;l++)(!1&o||i>=o)&&Object.keys(r.O).every((e=>r.O[e](s[l])))?s.splice(l--,1):(a=!1,o<i&&(i=o));if(a){e.splice(d--,1);var c=n();void 0!==c&&(t=c)}}return t}o=o||0;for(var d=e.length;d>0&&e[d-1][2]>o;d--)e[d]=e[d-1];e[d]=[s,n,o]},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={593:0,749:0};r.O.j=t=>0===e[t];var t=(t,s)=>{var n,o,[i,a,l]=s,c=0;if(i.some((t=>0!==e[t]))){for(n in a)r.o(a,n)&&(r.m[n]=a[n]);if(l)var d=l(r)}for(t&&t(s);c<i.length;c++)o=i[c],r.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return r.O(d)},s=globalThis.webpackChunkyoubookpro=globalThis.webpackChunkyoubookpro||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();var n=r.O(void 0,[749],(()=>r(628)));n=r.O(n)})();