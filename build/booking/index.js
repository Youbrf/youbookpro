(()=>{"use strict";var e,t={140:(e,t,o)=>{const n=window.wp.blocks,r=window.wp.i18n,s=window.wp.blockEditor,l=window.wp.components,i=window.React;var a=o(338);function c(e){return e.reduce(((e,t)=>{const o=t.category?.name||"Autres";return e[o]||(e[o]=[]),e[o].push(t),e}),{})}function u(e){const t=document.createElement("textarea");return t.innerHTML=e,t.value}function d(e){return`${Math.floor(e/60).toString().padStart(2,"0")}:${(e%60).toString().padStart(2,"0")}`}function h(e,t,o,n,r,s){const l=[];for(let e=o;e<=n-t;e+=r)l.push(e);const i=e.map((e=>{const t=function(e){const[t,o]=e.split(":").map(Number);return 60*t+o}(e.time);return{start:t,end:t+parseInt(e.duration)}})),a=new Date,c=s===a.toISOString().split("T")[0],u=60*a.getHours()+a.getMinutes();return l.filter((e=>{const o=e+t;return!(c&&e<=u||i.some((t=>e<t.end&&o>t.start)))})).map(d)}async function p(e){try{const t=await fetch(`/wp-json/youbookpro/v1/reservations?date=${e}`);return await t.json()}catch(e){return console.error("Erreur lors de la récupération des réservations :",e),[]}}const v=1080,m=window.ReactJSXRuntime,x=function({services:e,selectedServices:t,toggleService:o,error:n,onNextStep:r}){const s=0===e.length&&!n;return(0,m.jsxs)("div",{className:"services-section",children:[s?(0,m.jsx)("p",{children:"Chargement des services..."}):Object.entries(c(e)).map((([e,n])=>(0,m.jsxs)("div",{className:"category-block",children:[(0,m.jsx)("h4",{className:"category-title",children:u(e)}),(0,m.jsx)("table",{className:"category-table desktop-only",children:(0,m.jsx)("tbody",{children:n.map((e=>(0,m.jsxs)("tr",{children:[(0,m.jsx)("td",{children:u(e.title)}),(0,m.jsxs)("td",{children:[e.price," €"]}),(0,m.jsxs)("td",{children:[e.duration," min"]}),(0,m.jsx)("td",{children:(0,m.jsx)("button",{onClick:()=>o(e),children:t.find((t=>t.id===e.id))?"Retirer":"Sélectionner"})})]},e.id)))})}),(0,m.jsx)("div",{className:"mobile-only",children:n.map((e=>(0,m.jsxs)("div",{className:"mobile-service",children:[(0,m.jsx)("div",{className:"service-title",children:u(e.title)}),(0,m.jsxs)("div",{className:"service-info",children:[(0,m.jsxs)("div",{className:"left-info",children:[(0,m.jsxs)("span",{children:[e.price," €"]})," • ",(0,m.jsxs)("span",{children:[e.duration," min"]})]}),(0,m.jsx)("div",{className:"right-button",children:(0,m.jsx)("button",{onClick:()=>o(e),children:t.find((t=>t.id===e.id))?"Retirer":"Sélectionner"})})]})]},e.id)))})]},e))),n&&(0,m.jsx)("div",{className:"error-popup",children:n}),t.length>0&&(0,m.jsxs)("div",{className:"next-step-bar centered",children:[(0,m.jsxs)("div",{children:[(0,m.jsx)("strong",{children:t.length})," service(s) sélectionné(s) –",(0,m.jsxs)("strong",{children:[" ",t.reduce(((e,t)=>e+parseFloat(t.price)),0)," €"]})]}),(0,m.jsx)("button",{onClick:r,children:"Choisir un créneau →"})]})]})};function j(e,t){const o=new Date(e);return o.setDate(o.getDate()+t),o}const b=function({totalDuration:e,selectedDate:t,setSelectedDate:o,setAvailableSlots:n}){const[r,s]=(0,i.useState)(new Date),[l,a]=(0,i.useState)([]),[c,u]=(0,i.useState)([]),d=l.some((e=>(e=>{const t=new Date;return e.getDate()===t.getDate()&&e.getMonth()===t.getMonth()&&e.getFullYear()===t.getFullYear()})(e)));return(0,i.useEffect)((()=>{(async()=>{try{const t=(new Date).toISOString().split("T")[0],o=await fetch(`/wp-json/youbookpro/v1/reservations/from?from=${t}`),r=await o.json(),s={};r.forEach((e=>{s[e.date]||(s[e.date]=[]),s[e.date].push(e)}));const l=Object.entries(s).filter((([t,o])=>0===h(o,e,600,v,30,o.date).length)).map((([e])=>e)),i=[],a=new Date;for(let e=0;e<30;e++){const t=new Date(a);t.setDate(a.getDate()+e),0===t.getDay()&&i.push(t.toISOString().split("T")[0])}const c=Array.from(new Set([...l,...i]));u(c),c.includes(t)||n(h(await p(t),e,600,v,30,t))}catch(e){console.error("Erreur lors de la récupération des dates désactivées:",e)}})()}),[e]),(0,i.useEffect)((()=>{a(function(e){const t=[];for(let o=0;o<7;o++){const n=new Date(e);n.setDate(n.getDate()+o),t.push(n)}return t}(r))}),[r]),(0,i.useEffect)((()=>{const e=(new Date).toISOString().split("T")[0];o(e)}),[]),(0,m.jsxs)("div",{className:"week-selector",children:[(0,m.jsx)("button",{onClick:()=>s(j(r,-7)),disabled:d,style:{opacity:d?.3:1,cursor:d?"not-allowed":"pointer"},title:d?"Impossible de revenir avant cette semaine":"Semaine précédente",children:"<"}),(0,m.jsx)("div",{className:"week-days",children:l.map((r=>{const s=r.getDate(),l=r.toISOString().split("T")[0],i=t===l,a=0===r.getDay()||c.includes(l);return(0,m.jsx)("button",{disabled:a,className:"day-btn "+(a?"disabled":i?"selected":"normal"),onClick:()=>(async t=>{if(0===t.getDay())return;const r=t.toISOString().split("T")[0];c.includes(r)||(o(r),n(h(await p(r),e,600,v,30,r)))})(r),title:a?"Jour indisponible":"",children:s},l)}))}),(0,m.jsx)("button",{onClick:()=>s(j(r,7)),children:">"})]})},f=({selectedServices:e,totalDuration:t,selectedDate:o,setSelectedDate:n,availableSlots:r,setAvailableSlots:s,selectedSlot:l,setSelectedSlot:a,onNextStep:c,onPrevStep:u,error:d})=>((0,i.useEffect)((()=>{a(null)}),[o]),(0,m.jsxs)("div",{className:"slots-section",children:[(0,m.jsxs)("div",{className:"slots-container",children:[(0,m.jsxs)("div",{className:"slots-left",children:[(0,m.jsx)("h3",{children:"Choix de la date et heure "}),(0,m.jsxs)("h5",{children:["Créneaux disponibles pour le ",(0,m.jsx)("strong",{children:o})]}),(0,m.jsx)(b,{setAvailableSlots:s,selectedDate:o,setSelectedDate:n,totalDuration:t}),o&&(0,m.jsx)("div",{children:r.length>0?(0,m.jsx)("div",{className:"slots-list",children:r.map((e=>(0,m.jsx)("button",{className:"slot-btn-vertical "+(l===e?"selected":""),onClick:()=>a(e),children:e},e)))}):(0,m.jsx)("p",{children:"Aucun créneau disponible pour cette date."})})]}),(0,m.jsxs)("div",{className:"slots-right",children:[(0,m.jsx)("h6",{children:"Prestation sélectionnée :"}),(0,m.jsx)("ul",{children:e.map((e=>(0,m.jsxs)("li",{children:[e.title," - ",e.duration," min"]},e.id)))})]})]}),l&&(0,m.jsxs)("div",{className:"next-step-bar centered",children:[(0,m.jsxs)("div",{children:[(0,m.jsx)("strong",{children:"Créneau sélectionné"})," ",l]}),(0,m.jsx)("button",{onClick:c,children:"Passer à l’étape suivante →"})]}),(0,m.jsx)("button",{onClick:u,children:"← Retour aux services"}),d&&(0,m.jsx)("div",{className:"error-popup",children:d})]})),S=function({selectedDate:e,selectedSlot:t,selectedServices:o,totalDuration:n,onSubmit:r,onPrevStep:s,error:l}){const[a,c]=(0,i.useState)(""),[u,d]=(0,i.useState)(""),[h,p]=(0,i.useState)(""),[v,x]=(0,i.useState)(""),[j,b]=(0,i.useState)(""),[f,S]=(0,i.useState)(null),[g,w]=(0,i.useState)(!0),[y,C]=(0,i.useState)(!1),[k,D]=(0,i.useState)(null),[N,T]=(0,i.useState)(!1),[O,E]=(0,i.useState)(!1);return(0,i.useEffect)((()=>{if(!window.youbookproData)return S(null),void w(!1);fetch(window.youbookproData.restUrl,{method:"GET",headers:{"X-WP-Nonce":window.youbookproData.nonce,"Content-Type":"application/json"},credentials:"same-origin"}).then((e=>{if(!e.ok)throw new Error("Utilisateur non connecté");return e.json()})).then((e=>{S(e),c(e.first_name||""),d(e.last_name||""),p(e.user_email||e.email||""),x(e.phone||""),w(!1)})).catch((()=>{S(null),w(!1)}))}),[]),g?(0,m.jsx)("p",{children:"Chargement..."}):(0,m.jsxs)("div",{className:"confirmation-section",children:[f?(0,m.jsxs)("p",{children:["Bienvenue, ",f.display_name," !"]}):(0,m.jsxs)("div",{children:[(0,m.jsx)("p",{children:"Vous n’êtes pas connecté, vous pouvez remplir le formulaire ci-dessous ou vous connecter."}),(0,m.jsx)("div",{style:{marginTop:"1em"},children:(0,m.jsx)("button",{onClick:()=>{!function({selectedDate:e,selectedSlot:t,selectedServices:o,totalDuration:n}){const r={selectedDate:e,selectedSlot:t,selectedServices:o,totalDuration:n};sessionStorage.setItem("bookingState",JSON.stringify(r))}({selectedDate:e,selectedSlot:t,selectedServices:o,totalDuration:n}),window.location.href="/my-account/?redirect_to="+encodeURIComponent(window.location.href)},children:"Se connecter"})})]}),(0,m.jsx)("h3",{children:"Confirmation de la réservation"}),(0,m.jsxs)("div",{className:"recap-condensed",children:[(0,m.jsxs)("p",{children:[(0,m.jsx)("strong",{children:e})," à ",(0,m.jsx)("strong",{children:t})," – ",(0,m.jsxs)("strong",{children:[n," min"]})]}),(0,m.jsx)("p",{children:o.map((e=>`${e.title} (${e.duration}min, ${parseFloat(e.price).toFixed(2)}€)`)).join(" · ")}),(0,m.jsxs)("p",{children:[(0,m.jsx)("strong",{children:"Total :"})," ",o.reduce(((e,t)=>e+parseFloat(t.price)),0).toFixed(2)," €"]})]}),(0,m.jsxs)("form",{onSubmit:async s=>{if(s.preventDefault(),D(null),T(!1),!(()=>{if(!f){if(!(a&&u&&h&&v))return D("Veuillez remplir tous les champs obligatoires."),!1;if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(h))return D("Veuillez entrer une adresse email valide."),!1}return D(null),!0})())return;C(!0);const l={first_name:a,last_name:u,email:h,phone:v,notes:j,date:e,time:t,services:o.map((e=>e.id)),duration:n,guest:!f};try{await r(l),T(!0)}catch(e){console.error("Erreur de soumission du formulaire:",e),D(e.message||"Une erreur est survenue lors de la réservation."),T(!1)}finally{C(!1)}},noValidate:!0,children:[!f&&(0,m.jsxs)(m.Fragment,{children:[(0,m.jsx)("input",{type:"text",placeholder:"Prénom *",name:"first_name",value:a,onChange:e=>c(e.target.value),required:!0}),(0,m.jsx)("input",{type:"text",placeholder:"Nom *",name:"last_name",value:u,onChange:e=>d(e.target.value),required:!0}),(0,m.jsx)("input",{type:"email",placeholder:"Email *",name:"email",value:h,onChange:e=>p(e.target.value),required:!0}),(0,m.jsx)("input",{type:"tel",placeholder:"Téléphone *",name:"phone",value:v,onChange:e=>x(e.target.value),required:!0})]}),(0,m.jsx)("textarea",{placeholder:"Notes liées au rendez-vous (optionnel)",name:"notes",value:j,onChange:e=>b(e.target.value),rows:3}),y&&(0,m.jsx)("p",{children:"Traitement de votre réservation..."}),k&&(0,m.jsx)("div",{className:"error-popup",children:k}),N&&(0,m.jsx)("div",{className:"success-popup",children:"Réservation effectuée avec succès !"}),l&&!k&&(0,m.jsx)("div",{className:"error-popup",children:l}),(0,m.jsx)("button",{type:"submit",disabled:y||N,children:y?"Confirmation en cours...":N?"Réservé !":"Confirmer la réservation"})]}),(0,m.jsx)("button",{onClick:s,disabled:y,children:"← Retour au créneau"})]})};function g({buttonColor:e,buttonTextColor:t,buttonHoverColor:o,buttonHoverTextColor:n}){const r={"--button-bg-color":e||"#000000","--button-text-color":t||"#ffffff","--button-hover-bg-color":o||"#333333","--button-hover-text-color":n||"#ffffff"},[s,l]=(0,i.useState)(1),[a,c]=(0,i.useState)([]),[u,d]=(0,i.useState)([]),[h,p]=(0,i.useState)(!0),[v,j]=(0,i.useState)(null),[b,g]=(0,i.useState)(null),[w,y]=(0,i.useState)([]),[C,k]=(0,i.useState)([]),[D,N]=(0,i.useState)(null),[T,O]=(0,i.useState)([]),E=a.reduce(((e,t)=>e+parseInt(t.duration)),0);return(0,i.useEffect)((()=>{(async function(){const e=await fetch("/wp-json/youbookpro/v1/services");if(!e.ok)throw new Error("Erreur chargement services");return e.json()})().then((e=>{d(e);const t=function(){const e=sessionStorage.getItem("bookingState");if(!e)return null;try{return JSON.parse(e)}catch{return sessionStorage.removeItem("bookingState"),null}}();if(t){g(t.selectedDate),N(t.selectedSlot);const o=t.selectedServices.map((t=>e.find((e=>e.id===t.id)))).filter(Boolean);c(o),l(3),sessionStorage.removeItem("bookingState")}})).catch((e=>{console.error(e),j("Impossible de charger les services.")}))}),[]),(0,i.useEffect)((()=>{if(v){const e=setTimeout((()=>j(null)),5e3);return()=>clearTimeout(e)}}),[v]),(0,m.jsxs)("div",{className:"youbookpro-booking",style:r,children:[1===s&&(0,m.jsx)(x,{services:u,selectedServices:a,toggleService:e=>{c((t=>t.find((t=>t.id===e.id))?(j(null),t.filter((t=>t.id!==e.id))):t.length>=2?(j("Vous pouvez sélectionner jusqu'à 2 services maximum."),t):(j(null),[...t,e])))},error:v,onNextStep:()=>{a.length>0?(l(2),j(null)):j("Veuillez sélectionner au moins un service.")}}),2===s&&(0,m.jsx)(f,{selectedServices:a,totalDuration:E,selectedDate:b,setSelectedDate:g,reservations:C,availableSlots:w,setAvailableSlots:y,selectedSlot:D,setSelectedSlot:N,disabledDates:T,setDisabledDatesGlobal:O,onNextStep:()=>{D?(l(3),j(null)):j("Veuillez sélectionner un créneau horaire.")},onPrevStep:()=>{l(1),j(null)},error:v}),3===s&&(0,m.jsx)(S,{selectedDate:b,selectedSlot:D,selectedServices:a,totalDuration:E,onSubmit:async e=>{try{const t=await fetch("/wp-json/youbookpro/v1/reserve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){const e=await t.json();throw new Error(e.message||"Erreur lors de la réservation")}const o=await t.json();return l(1),c([]),N(null),g(null),k([]),y([]),o}catch(e){throw console.error("Erreur lors de la réservation (dans BookingBlock) :",e),e}},onPrevStep:()=>{l(2),j(null)},error:v})]})}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("youbookpro-booking-root");e&&(0,a.H)(e).render((0,m.jsx)(g,{}))}));const w=g,y=JSON.parse('{"UU":"youbookpro/booking"}');(0,n.registerBlockType)(y.UU,{edit:function({attributes:e,setAttributes:t}){const o=(0,s.useBlockProps)(),{buttonColor:n,buttonTextColor:i,buttonHoverColor:a,buttonHoverTextColor:c}=e;return(0,m.jsxs)(m.Fragment,{children:[(0,m.jsx)(s.InspectorControls,{children:(0,m.jsxs)(l.PanelBody,{title:(0,r.__)("Bouton","youbookpro"),initialOpen:!0,children:[(0,m.jsx)("p",{children:(0,r.__)("Couleur du bouton","youbookpro")}),(0,m.jsx)(s.ColorPalette,{value:n,onChange:e=>t({buttonColor:e})}),(0,m.jsx)("p",{children:(0,r.__)("Couleur du texte du bouton","youbookpro")}),(0,m.jsx)(s.ColorPalette,{value:i,onChange:e=>t({buttonTextColor:e})}),(0,m.jsx)("p",{children:(0,r.__)("Couleur du bouton au survol","youbookpro")}),(0,m.jsx)(s.ColorPalette,{value:a,onChange:e=>t({buttonHoverColor:e})}),(0,m.jsx)("p",{children:(0,r.__)("Couleur du texte au survol","youbookpro")}),(0,m.jsx)(s.ColorPalette,{value:c,onChange:e=>t({buttonHoverTextColor:e})})]})}),(0,m.jsx)("div",{...o,children:(0,m.jsx)(w,{buttonColor:n,buttonTextColor:i,buttonHoverColor:a,buttonHoverTextColor:c})})]})},save:function(){return null}})},338:(e,t,o)=>{var n=o(795);t.H=n.createRoot,n.hydrateRoot},795:e=>{e.exports=window.ReactDOM}},o={};function n(e){var r=o[e];if(void 0!==r)return r.exports;var s=o[e]={exports:{}};return t[e](s,s.exports,n),s.exports}n.m=t,e=[],n.O=(t,o,r,s)=>{if(!o){var l=1/0;for(u=0;u<e.length;u++){for(var[o,r,s]=e[u],i=!0,a=0;a<o.length;a++)(!1&s||l>=s)&&Object.keys(n.O).every((e=>n.O[e](o[a])))?o.splice(a--,1):(i=!1,s<l&&(l=s));if(i){e.splice(u--,1);var c=r();void 0!==c&&(t=c)}}return t}s=s||0;for(var u=e.length;u>0&&e[u-1][2]>s;u--)e[u]=e[u-1];e[u]=[o,r,s]},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={593:0,749:0};n.O.j=t=>0===e[t];var t=(t,o)=>{var r,s,[l,i,a]=o,c=0;if(l.some((t=>0!==e[t]))){for(r in i)n.o(i,r)&&(n.m[r]=i[r]);if(a)var u=a(n)}for(t&&t(o);c<l.length;c++)s=l[c],n.o(e,s)&&e[s]&&e[s][0](),e[s]=0;return n.O(u)},o=globalThis.webpackChunkyoubookpro=globalThis.webpackChunkyoubookpro||[];o.forEach(t.bind(null,0)),o.push=t.bind(null,o.push.bind(o))})();var r=n.O(void 0,[749],(()=>n(140)));r=n.O(r)})();