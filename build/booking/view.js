(()=>{"use strict";var e={338:(e,t,s)=>{var n=s(795);t.H=n.createRoot,n.hydrateRoot},795:e=>{e.exports=window.ReactDOM}},t={};const s=window.React;var n=function s(n){var r=t[n];if(void 0!==r)return r.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,s),o.exports}(338);function r(e){return e.reduce(((e,t)=>{const s=t.category?.name||"Autres";return e[s]||(e[s]=[]),e[s].push(t),e}),{})}function o(e){const t=document.createElement("textarea");return t.innerHTML=e,t.value}function i(e){return`${Math.floor(e/60).toString().padStart(2,"0")}:${(e%60).toString().padStart(2,"0")}`}function l(e,t,s,n,r,o){const l=[];for(let e=s;e<=n-t;e+=r)l.push(e);const a=e.map((e=>{const t=function(e){const[t,s]=e.split(":").map(Number);return 60*t+s}(e.time);return{start:t,end:t+parseInt(e.duration)}})),c=new Date,d=o===c.toISOString().split("T")[0],u=60*c.getHours()+c.getMinutes();return l.filter((e=>{const s=e+t;return!(d&&e<=u||a.some((t=>e<t.end&&s>t.start)))})).map(i)}async function a(e){try{const t=await fetch(`/wp-json/youbookpro/v1/reservations?date=${e}`);return await t.json()}catch(e){return console.error("Erreur lors de la récupération des réservations :",e),[]}}const c=1080,d=window.ReactJSXRuntime,u=function({services:e,selectedServices:t,toggleService:s,error:n,onNextStep:i}){const l=0===e.length&&!n;return(0,d.jsxs)("div",{className:"services-section",children:[l?(0,d.jsx)("p",{children:"Chargement des services..."}):Object.entries(r(e)).map((([e,n])=>(0,d.jsxs)("div",{className:"category-block",children:[(0,d.jsx)("h4",{className:"category-title",children:o(e)}),(0,d.jsx)("table",{className:"category-table desktop-only",children:(0,d.jsx)("tbody",{children:n.map((e=>(0,d.jsxs)("tr",{children:[(0,d.jsx)("td",{children:o(e.title)}),(0,d.jsxs)("td",{children:[e.price," €"]}),(0,d.jsxs)("td",{children:[e.duration," min"]}),(0,d.jsx)("td",{children:(0,d.jsx)("button",{onClick:()=>s(e),children:t.find((t=>t.id===e.id))?"Retirer":"Sélectionner"})})]},e.id)))})}),(0,d.jsx)("div",{className:"mobile-only",children:n.map((e=>(0,d.jsxs)("div",{className:"mobile-service",children:[(0,d.jsx)("div",{className:"service-title",children:o(e.title)}),(0,d.jsxs)("div",{className:"service-info",children:[(0,d.jsxs)("div",{className:"left-info",children:[(0,d.jsxs)("span",{children:[e.price," €"]})," • ",(0,d.jsxs)("span",{children:[e.duration," min"]})]}),(0,d.jsx)("div",{className:"right-button",children:(0,d.jsx)("button",{onClick:()=>s(e),children:t.find((t=>t.id===e.id))?"Retirer":"Sélectionner"})})]})]},e.id)))})]},e))),n&&(0,d.jsx)("div",{className:"error-popup",children:n}),t.length>0&&(0,d.jsxs)("div",{className:"next-step-bar centered",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("strong",{children:t.length})," service(s) sélectionné(s) –",(0,d.jsxs)("strong",{children:[" ",t.reduce(((e,t)=>e+parseFloat(t.price)),0)," €"]})]}),(0,d.jsx)("button",{onClick:i,children:"Choisir un créneau →"})]})]})};function h(e,t){const s=new Date(e);return s.setDate(s.getDate()+t),s}const p=function({totalDuration:e,selectedDate:t,setSelectedDate:n,setAvailableSlots:r}){const[o,i]=(0,s.useState)(new Date),[u,p]=(0,s.useState)([]),[m,v]=(0,s.useState)([]),x=u.some((e=>(e=>{const t=new Date;return e.getDate()===t.getDate()&&e.getMonth()===t.getMonth()&&e.getFullYear()===t.getFullYear()})(e)));return(0,s.useEffect)((()=>{(async()=>{try{const t=(new Date).toISOString().split("T")[0],s=await fetch(`/wp-json/youbookpro/v1/reservations/from?from=${t}`),n=await s.json(),o={};n.forEach((e=>{o[e.date]||(o[e.date]=[]),o[e.date].push(e)}));const i=Object.entries(o).filter((([t,s])=>0===l(s,e,600,c,30,s.date).length)).map((([e])=>e)),d=[],u=new Date;for(let e=0;e<30;e++){const t=new Date(u);t.setDate(u.getDate()+e),0===t.getDay()&&d.push(t.toISOString().split("T")[0])}const h=Array.from(new Set([...i,...d]));v(h),h.includes(t)||r(l(await a(t),e,600,c,30,t))}catch(e){console.error("Erreur lors de la récupération des dates désactivées:",e)}})()}),[e]),(0,s.useEffect)((()=>{p(function(e){const t=[];for(let s=0;s<7;s++){const n=new Date(e);n.setDate(n.getDate()+s),t.push(n)}return t}(o))}),[o]),(0,s.useEffect)((()=>{const e=(new Date).toISOString().split("T")[0];n(e)}),[]),(0,d.jsxs)("div",{className:"week-selector",children:[(0,d.jsx)("button",{onClick:()=>i(h(o,-7)),disabled:x,style:{opacity:x?.3:1,cursor:x?"not-allowed":"pointer"},title:x?"Impossible de revenir avant cette semaine":"Semaine précédente",children:"<"}),(0,d.jsx)("div",{className:"week-days",children:u.map((s=>{const o=s.getDate(),i=s.toISOString().split("T")[0],u=t===i,h=0===s.getDay()||m.includes(i);return(0,d.jsx)("button",{disabled:h,className:"day-btn "+(h?"disabled":u?"selected":"normal"),onClick:()=>(async t=>{if(0===t.getDay())return;const s=t.toISOString().split("T")[0];m.includes(s)||(n(s),r(l(await a(s),e,600,c,30,s)))})(s),title:h?"Jour indisponible":"",children:o},i)}))}),(0,d.jsx)("button",{onClick:()=>i(h(o,7)),children:">"})]})},m=({selectedServices:e,totalDuration:t,selectedDate:n,setSelectedDate:r,availableSlots:o,setAvailableSlots:i,selectedSlot:l,setSelectedSlot:a,onNextStep:c,onPrevStep:u,error:h})=>((0,s.useEffect)((()=>{a(null)}),[n]),(0,d.jsxs)("div",{className:"slots-section",children:[(0,d.jsxs)("div",{className:"slots-container",children:[(0,d.jsxs)("div",{className:"slots-left",children:[(0,d.jsx)("h3",{children:"Choix de la date et heure "}),(0,d.jsxs)("h5",{children:["Créneaux disponibles pour le ",(0,d.jsx)("strong",{children:n})]}),(0,d.jsx)(p,{setAvailableSlots:i,selectedDate:n,setSelectedDate:r,totalDuration:t}),n&&(0,d.jsx)("div",{children:o.length>0?(0,d.jsx)("div",{className:"slots-list",children:o.map((e=>(0,d.jsx)("button",{className:"slot-btn-vertical "+(l===e?"selected":""),onClick:()=>a(e),children:e},e)))}):(0,d.jsx)("p",{children:"Aucun créneau disponible pour cette date."})})]}),(0,d.jsxs)("div",{className:"slots-right",children:[(0,d.jsx)("h6",{children:"Prestation sélectionnée :"}),(0,d.jsx)("ul",{children:e.map((e=>(0,d.jsxs)("li",{children:[e.title," - ",e.duration," min"]},e.id)))})]})]}),l&&(0,d.jsxs)("div",{className:"next-step-bar centered",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("strong",{children:"Créneau sélectionné"})," ",l]}),(0,d.jsx)("button",{onClick:c,children:"Passer à l’étape suivante →"})]}),(0,d.jsx)("button",{onClick:u,children:"← Retour aux services"}),h&&(0,d.jsx)("div",{className:"error-popup",children:h})]})),v=function({selectedDate:e,selectedSlot:t,selectedServices:n,totalDuration:r,onSubmit:o,onPrevStep:i,error:l}){const[a,c]=(0,s.useState)(""),[u,h]=(0,s.useState)(""),[p,m]=(0,s.useState)(""),[v,x]=(0,s.useState)(""),[j,f]=(0,s.useState)(""),[S,g]=(0,s.useState)(null),[b,D]=(0,s.useState)(!0),[y,w]=(0,s.useState)(!1),[C,N]=(0,s.useState)(null),[k,E]=(0,s.useState)(!1),[T,I]=(0,s.useState)(!1);return(0,s.useEffect)((()=>{if(!window.youbookproData)return g(null),void D(!1);fetch(window.youbookproData.restUrl,{method:"GET",headers:{"X-WP-Nonce":window.youbookproData.nonce,"Content-Type":"application/json"},credentials:"same-origin"}).then((e=>{if(!e.ok)throw new Error("Utilisateur non connecté");return e.json()})).then((e=>{g(e),c(e.first_name||""),h(e.last_name||""),m(e.user_email||e.email||""),x(e.phone||""),D(!1)})).catch((()=>{g(null),D(!1)}))}),[]),b?(0,d.jsx)("p",{children:"Chargement..."}):(0,d.jsxs)("div",{className:"confirmation-section",children:[S?(0,d.jsxs)("p",{children:["Bienvenue, ",S.display_name," !"]}):(0,d.jsxs)("div",{children:[(0,d.jsx)("p",{children:"Vous n’êtes pas connecté, vous pouvez remplir le formulaire ci-dessous ou vous connecter."}),(0,d.jsx)("div",{style:{marginTop:"1em"},children:(0,d.jsx)("button",{onClick:()=>{!function({selectedDate:e,selectedSlot:t,selectedServices:s,totalDuration:n}){const r={selectedDate:e,selectedSlot:t,selectedServices:s,totalDuration:n};sessionStorage.setItem("bookingState",JSON.stringify(r))}({selectedDate:e,selectedSlot:t,selectedServices:n,totalDuration:r}),window.location.href="/my-account/?redirect_to="+encodeURIComponent(window.location.href)},children:"Se connecter"})})]}),(0,d.jsx)("h3",{children:"Confirmation de la réservation"}),(0,d.jsxs)("div",{className:"recap-condensed",children:[(0,d.jsxs)("p",{children:[(0,d.jsx)("strong",{children:e})," à ",(0,d.jsx)("strong",{children:t})," – ",(0,d.jsxs)("strong",{children:[r," min"]})]}),(0,d.jsx)("p",{children:n.map((e=>`${e.title} (${e.duration}min, ${parseFloat(e.price).toFixed(2)}€)`)).join(" · ")}),(0,d.jsxs)("p",{children:[(0,d.jsx)("strong",{children:"Total :"})," ",n.reduce(((e,t)=>e+parseFloat(t.price)),0).toFixed(2)," €"]})]}),(0,d.jsxs)("form",{onSubmit:async s=>{if(s.preventDefault(),N(null),E(!1),!(()=>{if(!S){if(!(a&&u&&p&&v))return N("Veuillez remplir tous les champs obligatoires."),!1;if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(p))return N("Veuillez entrer une adresse email valide."),!1}return N(null),!0})())return;w(!0);const i={first_name:a,last_name:u,email:p,phone:v,notes:j,date:e,time:t,services:n.map((e=>e.id)),duration:r,guest:!S};try{await o(i),E(!0)}catch(e){console.error("Erreur de soumission du formulaire:",e),N(e.message||"Une erreur est survenue lors de la réservation."),E(!1)}finally{w(!1)}},noValidate:!0,children:[!S&&(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("input",{type:"text",placeholder:"Prénom *",name:"first_name",value:a,onChange:e=>c(e.target.value),required:!0}),(0,d.jsx)("input",{type:"text",placeholder:"Nom *",name:"last_name",value:u,onChange:e=>h(e.target.value),required:!0}),(0,d.jsx)("input",{type:"email",placeholder:"Email *",name:"email",value:p,onChange:e=>m(e.target.value),required:!0}),(0,d.jsx)("input",{type:"tel",placeholder:"Téléphone *",name:"phone",value:v,onChange:e=>x(e.target.value),required:!0})]}),(0,d.jsx)("textarea",{placeholder:"Notes liées au rendez-vous (optionnel)",name:"notes",value:j,onChange:e=>f(e.target.value),rows:3}),y&&(0,d.jsx)("p",{children:"Traitement de votre réservation..."}),C&&(0,d.jsx)("div",{className:"error-popup",children:C}),k&&(0,d.jsx)("div",{className:"success-popup",children:"Réservation effectuée avec succès !"}),l&&!C&&(0,d.jsx)("div",{className:"error-popup",children:l}),(0,d.jsx)("button",{type:"submit",disabled:y||k,children:y?"Confirmation en cours...":k?"Réservé !":"Confirmer la réservation"})]}),(0,d.jsx)("button",{onClick:i,disabled:y,children:"← Retour au créneau"})]})},x=({confirmationData:e})=>e?(0,d.jsxs)("div",{className:"confirmation-success",children:[(0,d.jsx)("h2",{children:"Réservation confirmée ✅"}),(0,d.jsx)("p",{children:"Merci pour votre réservation ! Voici les détails :"}),(0,d.jsxs)("ul",{children:[(0,d.jsxs)("li",{children:[(0,d.jsx)("strong",{children:"Date :"})," ",e.selectedDate]}),(0,d.jsxs)("li",{children:[(0,d.jsx)("strong",{children:"Heure :"})," ",e.selectedSlot]}),(0,d.jsxs)("li",{children:[(0,d.jsx)("strong",{children:"Services :"}),(0,d.jsx)("ul",{children:e.selectedServices.map((e=>(0,d.jsx)("li",{children:e.name},e.id)))})]}),(0,d.jsxs)("li",{children:[(0,d.jsx)("strong",{children:"Numéro de réservation :"})," #",e.reservationId]})]})]}):null;function j({buttonColor:e,buttonTextColor:t,buttonHoverColor:n,buttonHoverTextColor:r}){const o={"--button-bg-color":e||"#000000","--button-text-color":t||"#ffffff","--button-hover-bg-color":n||"#333333","--button-hover-text-color":r||"#ffffff"},[i,l]=(0,s.useState)(1),[a,c]=(0,s.useState)([]),[h,p]=(0,s.useState)([]),[j,f]=(0,s.useState)(!0),[S,g]=(0,s.useState)(null),[b,D]=(0,s.useState)(null),[y,w]=(0,s.useState)([]),[C,N]=(0,s.useState)([]),[k,E]=(0,s.useState)(null),[T,I]=(0,s.useState)([]),O=a.reduce(((e,t)=>e+parseInt(t.duration)),0),[R,H]=(0,s.useState)(null);return(0,s.useEffect)((()=>{(async function(){const e=await fetch("/wp-json/youbookpro/v1/services");if(!e.ok)throw new Error("Erreur chargement services");return e.json()})().then((e=>{p(e);const t=function(){const e=sessionStorage.getItem("bookingState");if(!e)return null;try{return JSON.parse(e)}catch{return sessionStorage.removeItem("bookingState"),null}}();if(t){D(t.selectedDate),E(t.selectedSlot);const s=t.selectedServices.map((t=>e.find((e=>e.id===t.id)))).filter(Boolean);c(s),l(3),sessionStorage.removeItem("bookingState")}})).catch((e=>{console.error(e),g("Impossible de charger les services.")}))}),[]),(0,s.useEffect)((()=>{if(S){const e=setTimeout((()=>g(null)),5e3);return()=>clearTimeout(e)}}),[S]),(0,d.jsxs)("div",{className:"youbookpro-booking",style:o,children:[1===i&&(0,d.jsx)(u,{services:h,selectedServices:a,toggleService:e=>{c((t=>t.find((t=>t.id===e.id))?(g(null),t.filter((t=>t.id!==e.id))):t.length>=2?(g("Vous pouvez sélectionner jusqu'à 2 services maximum."),t):(g(null),[...t,e])))},error:S,onNextStep:()=>{a.length>0?(l(2),g(null)):g("Veuillez sélectionner au moins un service.")}}),2===i&&(0,d.jsx)(m,{selectedServices:a,totalDuration:O,selectedDate:b,setSelectedDate:D,reservations:C,availableSlots:y,setAvailableSlots:w,selectedSlot:k,setSelectedSlot:E,disabledDates:T,setDisabledDatesGlobal:I,onNextStep:()=>{k?(l(3),g(null)):g("Veuillez sélectionner un créneau horaire.")},onPrevStep:()=>{l(1),g(null)},error:S}),3===i&&(0,d.jsx)(v,{selectedDate:b,selectedSlot:k,selectedServices:a,totalDuration:O,onSubmit:async e=>{try{const t=await fetch("/wp-json/youbookpro/v1/reserve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){const e=await t.json();throw new Error(e.message||"Erreur lors de la réservation")}const s=await t.json();return H({selectedDate:b,selectedSlot:k,selectedServices:a,user:s.user,reservationId:s.reservation_id}),l(4),c([]),E(null),D(null),N([]),w([]),s}catch(e){throw console.error("Erreur lors de la réservation (dans BookingBlock) :",e),e}},onPrevStep:()=>{l(2),g(null)},error:S}),4===i&&(0,d.jsx)(x,{confirmationData:R})]})}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("youbookpro-booking-root");e&&(0,n.H)(e).render((0,d.jsx)(j,{}))}));const f=j;document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("youbookpro-booking-root");if(e){const t=e.dataset.buttonColor||"#0073aa",s=e.dataset.buttonTextColor||"#ffffff",r=e.dataset.buttonHoverColor||"#005177",o=e.dataset.buttonHoverTextColor||"#ffffff";(0,n.H)(e).render((0,d.jsx)(f,{buttonColor:t,buttonTextColor:s,buttonHoverColor:r,buttonHoverTextColor:o}))}}))})();