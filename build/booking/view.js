(()=>{"use strict";var e={338:(e,t,r)=>{var s=r(795);t.H=s.createRoot,s.hydrateRoot},795:e=>{e.exports=window.ReactDOM}},t={};const r=window.React;var s=function r(s){var n=t[s];if(void 0!==n)return n.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,r),o.exports}(338);function n(e){return e.reduce(((e,t)=>{const r=t.category?.name||"Autres";return e[r]||(e[r]=[]),e[r].push(t),e}),{})}function o(e){const t=document.createElement("textarea");return t.innerHTML=e,t.value}function a(e){const[t,r]=e.split(":").map(Number);return 60*t+r}function i(e){return`${Math.floor(e/60).toString().padStart(2,"0")}:${(e%60).toString().padStart(2,"0")}`}function l(e,t,r,s,n){const o=[];for(let e=r;e<=s-t;e+=n)o.push(e);const l=e.map((e=>{const t=a(e.time);return{start:t,end:t+parseInt(e.duration)}}));return o.filter((e=>{const r=e+t,s=l.some((t=>e<t.end&&r>t.start));return console.log(`${i(e)} - ${i(r)} => ${s?"❌ pris":"✅ libre"}`),!s}))}const c=window.ReactJSXRuntime,d=function({services:e,selectedServices:t,toggleService:r,error:s,onNextStep:a}){const i=0===e.length&&!s;return(0,c.jsxs)("div",{className:"services-section",children:[i?(0,c.jsx)("p",{children:"Chargement des services..."}):Object.entries(n(e)).map((([e,s])=>(0,c.jsxs)("div",{className:"category-block",children:[(0,c.jsx)("h4",{className:"category-title",children:o(e)}),(0,c.jsxs)("table",{className:"category-table",children:[(0,c.jsx)("thead",{children:(0,c.jsxs)("tr",{children:[(0,c.jsx)("th",{children:"Nom"}),(0,c.jsx)("th",{children:"Prix"}),(0,c.jsx)("th",{children:"Durée"}),(0,c.jsx)("th",{})]})}),(0,c.jsx)("tbody",{children:s.map((e=>(0,c.jsxs)("tr",{children:[(0,c.jsx)("td",{children:o(e.title)}),(0,c.jsxs)("td",{children:[e.price," €"]}),(0,c.jsxs)("td",{children:[e.duration," min"]}),(0,c.jsx)("td",{children:(0,c.jsx)("button",{onClick:()=>r(e),children:t.find((t=>t.id===e.id))?"Retirer":"Sélectionner"})})]},e.id)))})]})]},e))),s&&(0,c.jsx)("div",{className:"error-popup",children:s}),t.length>0&&(0,c.jsxs)("div",{className:"next-step-bar centered",children:[(0,c.jsxs)("div",{children:[(0,c.jsx)("strong",{children:t.length})," service(s) sélectionné(s) –",(0,c.jsxs)("strong",{children:[" ",t.reduce(((e,t)=>e+parseFloat(t.price)),0)," €"]})]}),(0,c.jsx)("button",{onClick:a,children:"Choisir un créneau →"})]})]})};function u(e,t){const r=new Date(e);return r.setDate(r.getDate()+t),r}const h=function({onDateSelected:e,totalDuration:t,onDisabledDatesFetched:s,selectedDate:n,setSelectedDate:o}){const[a,i]=(0,r.useState)(new Date),[d,h]=(0,r.useState)([]),[p,m]=(0,r.useState)([]),x=d.some((e=>(e=>{const t=new Date;return e.getDate()===t.getDate()&&e.getMonth()===t.getMonth()&&e.getFullYear()===t.getFullYear()})(e)));return(0,r.useEffect)((()=>{(async()=>{try{const e=(new Date).toISOString().split("T")[0],r=await fetch(`/wp-json/youbookpro/v1/reservations/from?from=${e}`),n=await r.json(),o={};n.forEach((e=>{o[e.date]||(o[e.date]=[]),o[e.date].push(e)}));const a=Object.entries(o).filter((([e,r])=>0===l(r,t,600,1080,30).length)).map((([e])=>e)),i=[],c=new Date;for(let e=0;e<30;e++){const t=new Date(c);t.setDate(c.getDate()+e),0===t.getDay()&&i.push(t.toISOString().split("T")[0])}const d=Array.from(new Set([...a,...i]));m(d),s?.(d)}catch(e){console.error("Erreur lors de la récupération des dates désactivées:",e)}})()}),[t]),(0,r.useEffect)((()=>{h(function(e){const t=[];for(let r=0;r<7;r++){const s=new Date(e);s.setDate(s.getDate()+r),t.push(s)}return t}(a))}),[a]),(0,r.useEffect)((()=>{const t=new Date,r=t.toISOString().split("T")[0];o(t),e(r)}),[]),(0,c.jsxs)("div",{className:"week-selector",children:[(0,c.jsx)("button",{onClick:()=>i(u(a,-7)),disabled:x,style:{opacity:x?.3:1,cursor:x?"not-allowed":"pointer"},title:x?"Impossible de revenir avant cette semaine":"Semaine précédente",children:"<"}),(0,c.jsx)("div",{className:"week-days",children:d.map((t=>{const r=t.getDate(),s=n?.toDateString()===t.toDateString(),a=0===t.getDay(),i=t.toISOString().split("T")[0],l=a||p.includes(i);return(0,c.jsx)("button",{disabled:l,className:`day-btn ${s?"selected":""} ${l?"disabled":""}`,onClick:()=>(t=>{if(0===t.getDay())return;const r=t.toISOString().split("T")[0];p.includes(r)||(o(t),e(r))})(t),title:l?"Jour indisponible":"",children:r},i)}))}),(0,c.jsx)("button",{onClick:()=>i(u(a,7)),children:">"})]})},p=({selectedServices:e,totalDuration:t,selectedDate:r,setSelectedDate:s,availableSlots:n,setAvailableSlots:o,selectedSlot:a,setSelectedSlot:i,fetchReservedSlots:l,onNextStep:d,onPrevStep:u,error:p})=>(0,c.jsxs)("div",{className:"slots-section",children:[(0,c.jsx)("h3",{children:"Créneaux disponibles pour :"}),(0,c.jsx)("ul",{children:e.map((e=>(0,c.jsxs)("li",{children:[e.title," - ",e.duration," min"]},e.id)))}),(0,c.jsx)("h3",{children:"Choisissez un jour :"}),(0,c.jsx)(h,{setSelectedDate:s,onDateSelected:e=>{s(e),l(e),i(null)},totalDuration:t}),r&&(0,c.jsxs)("div",{children:[(0,c.jsxs)("h4",{children:["Créneaux disponibles pour le ",r]}),n.length>0?(0,c.jsx)("div",{style:{display:"flex",flexDirection:"column",gap:"10px",marginTop:"10px"},children:n.map((e=>(0,c.jsx)("button",{className:"slot-btn-vertical "+(a===e?"selected":""),onClick:()=>i(e),children:e},e)))}):(0,c.jsx)("p",{children:"Aucun créneau disponible pour cette date."})]}),a&&(0,c.jsxs)("div",{className:"next-step-bar centered",children:[(0,c.jsxs)("div",{children:[(0,c.jsx)("strong",{children:"Créneau sélectionné :"})," ",a]}),(0,c.jsx)("button",{onClick:d,children:"Passer à l’étape suivante →"})]}),(0,c.jsx)("button",{onClick:u,children:"← Retour aux services"}),p&&(0,c.jsx)("div",{className:"error-popup",children:p})]}),m=function({selectedDate:e,selectedSlot:t,selectedServices:s,totalDuration:n,onSubmit:o,onPrevStep:a,error:i}){const[l,d]=(0,r.useState)(""),[u,h]=(0,r.useState)(""),[p,m]=(0,r.useState)(""),[x,v]=(0,r.useState)(""),[j,S]=(0,r.useState)(!1),[g,f]=(0,r.useState)(null),[b,D]=(0,r.useState)(!1);return(0,c.jsxs)("div",{className:"confirmation-section",children:[(0,c.jsx)("h3",{children:"Confirmation de la réservation"}),(0,c.jsxs)("p",{children:[(0,c.jsx)("strong",{children:"Date :"})," ",e]}),(0,c.jsxs)("p",{children:[(0,c.jsx)("strong",{children:"Heure :"})," ",t]}),(0,c.jsx)("ul",{children:s.map((e=>(0,c.jsxs)("li",{children:[e.title," – ",e.duration," min"]},e.id)))}),(0,c.jsxs)("p",{children:[(0,c.jsx)("strong",{children:"Durée totale :"})," ",n," min"]}),(0,c.jsxs)("p",{children:[(0,c.jsx)("strong",{children:"Montant total :"})," ",s.reduce(((e,t)=>e+parseFloat(t.price)),0)," €"]}),(0,c.jsxs)("form",{onSubmit:async r=>{if(r.preventDefault(),f(null),D(!1),!(l&&u&&p&&x?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(p)?(f(null),1):(f("Veuillez entrer une adresse email valide."),0):(f("Veuillez remplir tous les champs."),0)))return;S(!0);const a={first_name:l,last_name:u,email:p,phone:x,date:e,time:t,services:s.map((e=>e.id)),duration:n};try{await o(a),D(!0)}catch(e){console.error("Erreur de soumission du formulaire:",e),f(e.message||"Une erreur est survenue lors de la réservation."),D(!1)}finally{S(!1)}},children:[" ",(0,c.jsx)("input",{type:"text",placeholder:"Prénom",name:"first_name",value:l,onChange:e=>d(e.target.value),required:!0}),(0,c.jsx)("input",{type:"text",placeholder:"Nom",name:"last_name",value:u,onChange:e=>h(e.target.value),required:!0}),(0,c.jsx)("input",{type:"email",placeholder:"Email",name:"email",value:p,onChange:e=>m(e.target.value),required:!0}),(0,c.jsx)("input",{type:"tel",placeholder:"Téléphone",name:"phone",value:x,onChange:e=>v(e.target.value),required:!0}),j&&(0,c.jsx)("p",{children:"Traitement de votre réservation..."}),g&&(0,c.jsx)("div",{className:"error-popup",children:g}),b&&(0,c.jsx)("div",{className:"success-popup",children:"Réservation effectuée avec succès !"}),i&&!g&&(0,c.jsx)("div",{className:"error-popup",children:i}),(0,c.jsx)("button",{type:"submit",disabled:j||b,children:j?"Confirmation en cours...":b?"Réservé !":"Confirmer la réservation"})]}),(0,c.jsx)("button",{onClick:a,disabled:j,children:"← Retour au créneau"})]})};function x(){const[e,t]=(0,r.useState)(1),[s,n]=(0,r.useState)([]),[o,u]=(0,r.useState)([]),[h,x]=(0,r.useState)(!0),[v,j]=(0,r.useState)(null),[S,g]=(0,r.useState)(null),[f,b]=(0,r.useState)([]),[D,y]=(0,r.useState)([]),[w,N]=(0,r.useState)(null),[k,C]=(0,r.useState)([]),E=s.reduce(((e,t)=>e+parseInt(t.duration)),0);return(0,r.useEffect)((()=>{fetch("/wp-json/youbookpro/v1/services").then((e=>{if(!e.ok)throw new Error("Erreur de chargement des services");return e.json()})).then((e=>{u(e),x(!1)})).catch((e=>{console.error("Erreur lors du chargement des services:",e),j("Impossible de charger les services."),x(!1)}))}),[]),(0,r.useEffect)((()=>{if(v){const e=setTimeout((()=>j(null)),5e3);return()=>clearTimeout(e)}}),[v]),(0,c.jsxs)("div",{className:"youbookpro-booking",children:[1===e&&(0,c.jsx)(d,{services:o,selectedServices:s,toggleService:e=>{n((t=>t.find((t=>t.id===e.id))?(j(null),t.filter((t=>t.id!==e.id))):t.length>=2?(j("Vous pouvez sélectionner jusqu'à 2 services maximum."),t):(j(null),[...t,e])))},error:v,onNextStep:()=>{s.length>0?(t(2),j(null)):j("Veuillez sélectionner au moins un service.")}}),2===e&&(0,c.jsx)(p,{selectedServices:s,totalDuration:E,selectedDate:S,setSelectedDate:g,reservations:D,availableSlots:f,setAvailableSlots:b,selectedSlot:w,setSelectedSlot:N,disabledDates:k,setDisabledDatesGlobal:C,fetchReservedSlots:e=>{if(k.includes(e))return console.log("Date désactivée, pas de fetch :",e),y([]),void b([]);console.log("Date activé, fetch :",e),fetch(`/wp-json/youbookpro/v1/reservations?date=${e}`).then((e=>{if(!e.ok)throw new Error("Erreur lors du chargement des réservations pour cette date");return e.json()})).then((e=>{y(e);const t=l(e.map((e=>({start:a(e.time),end:a(e.time)+parseInt(e.duration)}))),E,600,1080,30);b(t.map(i))})).catch((e=>{console.error("Erreur lors du fetch des réservations :",e),j("Erreur lors du chargement des créneaux."),y([]),b([])}))},onNextStep:()=>{w?(t(3),j(null)):j("Veuillez sélectionner un créneau horaire.")},onPrevStep:()=>{t(1),j(null)},error:v}),3===e&&(0,c.jsx)(m,{selectedDate:S,selectedSlot:w,selectedServices:s,totalDuration:E,onSubmit:async e=>{try{const r=await fetch("/wp-json/youbookpro/v1/reserve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!r.ok){const e=await r.json();throw new Error(e.message||"Erreur lors de la réservation")}const s=await r.json();return t(1),n([]),N(null),g(null),y([]),b([]),s}catch(e){throw console.error("Erreur lors de la réservation (dans BookingBlock) :",e),e}},onPrevStep:()=>{t(2),j(null)},error:v})]})}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("youbookpro-booking-root");e&&(0,s.H)(e).render((0,c.jsx)(x,{}))}))})();