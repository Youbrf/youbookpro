(()=>{"use strict";var e={338:(e,t,n)=>{var r=n(795);t.H=r.createRoot,r.hydrateRoot},795:e=>{e.exports=window.ReactDOM}},t={};const n=window.React;var r=function n(r){var s=t[r];if(void 0!==s)return s.exports;var o=t[r]={exports:{}};return e[r](o,o.exports,n),o.exports}(338);const s=window.ReactJSXRuntime;function o(){const[e,t]=(0,n.useState)(1),[r,o]=(0,n.useState)([]),[l,d]=(0,n.useState)([]),[u,h]=(0,n.useState)(!0),[p,m]=(0,n.useState)(null),[x,j]=(0,n.useState)(null),[f,v]=(0,n.useState)([]),[g,b]=(0,n.useState)([]),[D,S]=(0,n.useState)([]),[y,w]=(0,n.useState)(null),k=r.reduce(((e,t)=>e+parseInt(t.duration)),0),[E,C]=(0,n.useState)([]),N=e=>{const t=k,n=[];for(let s=600;s<=1080-t;s+=30){const o=s,i=s+t;i>1080||(e.some((e=>o<e.end&&i>e.start))||n.push((r=o,`${Math.floor(r/60).toString().padStart(2,"0")}:${(r%60).toString().padStart(2,"0")}`)))}var r;b(n)};return(0,n.useEffect)((()=>{fetch("/wp-json/youbookpro/v1/reservations").then((e=>{if(!e.ok)throw new Error("Erreur lors du chargement des réservations");return e.json()})).then((e=>{S(e)})).catch((e=>{console.error("Erreur fetch réservations:",e)}))}),[]),(0,n.useEffect)((()=>{fetch("/wp-json/youbookpro/v1/services").then((e=>{if(!e.ok)throw new Error("Erreur de chargement des services");return e.json()})).then((e=>{d(e),h(!1)})).catch((e=>{console.error("Erreur lors du chargement des services:",e),h(!1)}))}),[]),(0,n.useEffect)((()=>{if(p){const e=setTimeout((()=>m(null)),3e3);return()=>clearTimeout(e)}}),[p]),(0,s.jsxs)("div",{className:"youbookpro-booking",children:[1===e&&(0,s.jsxs)("div",{className:"services-section",children:[u?(0,s.jsx)("p",{children:"Chargement des services..."}):Object.entries(i(l)).map((([e,t])=>(0,s.jsxs)("div",{className:"category-block",children:[(0,s.jsx)("h4",{className:"category-title",children:a(e)}),(0,s.jsxs)("table",{className:"category-table",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"Nom"}),(0,s.jsx)("th",{children:"Prix"}),(0,s.jsx)("th",{children:"Durée"}),(0,s.jsx)("th",{})]})}),(0,s.jsx)("tbody",{children:t.map((e=>(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:a(e.title)}),(0,s.jsxs)("td",{children:[e.price," €"]}),(0,s.jsxs)("td",{children:[e.duration," min"]}),(0,s.jsx)("td",{children:(0,s.jsx)("button",{onClick:()=>(e=>{o((t=>t.find((t=>t.id===e.id))?(m(null),t.filter((t=>t.id!==e.id))):t.length>=2?(m("Vous pouvez sélectionner jusqu'à 2 services maximum."),t):(m(null),[...t,e])))})(e),children:r.find((t=>t.id===e.id))?"Retirer":"Sélectionner"})})]},e.id)))})]})]},e))),p&&(0,s.jsx)("div",{className:"error-popup",children:p}),r.length>0&&(0,s.jsxs)("div",{className:"next-step-bar centered",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:r.length})," service(s) sélectionné(s) –",(0,s.jsxs)("strong",{children:[" ",r.reduce(((e,t)=>e+parseFloat(t.price)),0)," €"]})]}),(0,s.jsx)("button",{onClick:()=>t(2),children:"Choisir un créneau →"})]})]}),2===e&&(0,s.jsxs)("div",{className:"slots-section",children:[(0,s.jsx)("h3",{children:"Créneaux disponibles pour :"}),(0,s.jsx)("ul",{children:r.map((e=>(0,s.jsxs)("li",{children:[a(e.title)," - ",e.duration," min"]},e.id)))}),(0,s.jsx)("h3",{children:"Choisissez un jour :"}),(0,s.jsx)(c,{onDisabledDatesFetched:e=>{console.log("Dates désactivées :",e),C(e)},onDateSelected:e=>{j(e),(e=>{if(E.includes(e))return console.log("Date désactivée, pas de fetch :",e),v([]),S([]),void N([]);console.log("Date activé, fetch :",e),fetch(`/wp-json/youbookpro/v1/reservations?date=${e}`).then((e=>e.json())).then((e=>{v(e.map((e=>e.time))),S(e);const t=e.map((e=>{const t=function(e){const[t,n]=e.split(":").map(Number);return 60*t+n}(e.time);return{start:t,end:t+parseInt(e.duration)}}));N(t)}))})(e)},totalDuration:k}),x&&(0,s.jsxs)("div",{children:[(0,s.jsxs)("h4",{children:["Créneaux disponibles pour le ",x]}),g.length>0?(0,s.jsx)("div",{style:{display:"flex",flexDirection:"column",gap:"10px",marginTop:"10px"},children:g.map((e=>(0,s.jsx)("button",{className:"slot-btn-vertical "+(y===e?"selected":""),onClick:()=>w(e),children:e},e)))}):(0,s.jsx)("p",{children:"Aucun créneau disponible."})]}),y&&(0,s.jsxs)("div",{className:"next-step-bar centered",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:"Créneau sélectionné :"})," ",y]}),(0,s.jsx)("button",{onClick:()=>t(3),children:"Passer à l’étape suivante →"})]}),(0,s.jsx)("button",{onClick:()=>t(1),children:"Retour"})]}),3===e&&(0,s.jsxs)("div",{className:"confirmation-section",children:[(0,s.jsx)("h3",{children:"Confirmation de la réservation"}),(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Date :"})," ",x]}),(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Heure :"})," ",y]}),(0,s.jsx)("ul",{children:r.map((e=>(0,s.jsxs)("li",{children:[a(e.title)," – ",e.duration," min"]},e.id)))}),(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Durée totale :"})," ",k," min"]}),(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Montant total :"})," ",r.reduce(((e,t)=>e+parseFloat(t.price)),0)," €"]}),(0,s.jsxs)("form",{onSubmit:e=>{e.preventDefault();const n=new FormData(e.target),s={first_name:n.get("first_name"),last_name:n.get("last_name"),email:n.get("email"),phone:n.get("phone"),date:x,time:y,services:r.map((e=>e.id)),duration:k};fetch("/wp-json/youbookpro/v1/reserve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}).then((e=>e.json())).then((e=>{alert("Réservation confirmée !"),t(1),o([]),w(null),j(null)})).catch((e=>{console.error("Erreur lors de la réservation :",e),alert("Erreur lors de la réservation.")}))},children:[(0,s.jsx)("input",{type:"text",placeholder:"Prénom",name:"first_name",required:!0}),(0,s.jsx)("input",{type:"text",placeholder:"Nom",name:"last_name",required:!0}),(0,s.jsx)("input",{type:"email",placeholder:"Email",name:"email",required:!0}),(0,s.jsx)("input",{type:"tel",placeholder:"Téléphone",name:"phone",required:!0}),(0,s.jsx)("button",{type:"submit",children:"Confirmer la réservation"})]}),(0,s.jsx)("button",{onClick:()=>t(2),children:"← Retour au créneau"})]})]})}function i(e){return e.reduce(((e,t)=>{const n=t.category?.name||"Autres";return e[n]||(e[n]=[]),e[n].push(t),e}),{})}function a(e){const t=document.createElement("textarea");return t.innerHTML=e,t.value}function c({onDateSelected:e,totalDuration:t,onDisabledDatesFetched:r}){const[o,i]=(0,n.useState)(new Date),[a,c]=(0,n.useState)(new Date),[d,u]=(0,n.useState)([]),[h,p]=(0,n.useState)([]),m=d.some((e=>(e=>{const t=new Date;return e.getDate()===t.getDate()&&e.getMonth()===t.getMonth()&&e.getFullYear()===t.getFullYear()})(e)));return(0,n.useEffect)((()=>{(async()=>{try{const e=(new Date).toISOString().split("T")[0],n=await fetch(`/wp-json/youbookpro/v1/reservations/from?from=${e}`),s=await n.json(),o={};s.forEach((e=>{o[e.date]||(o[e.date]=[]),o[e.date].push(e)}));const i=Object.entries(o).filter((([e,n])=>{const r=function(e,t){const n=[];for(let e=600;e<=1080-t;e+=30)n.push(e);const r=e.map((e=>{const[t,n]=e.time.split(":").map(Number),r=60*t+n;return{start:r,end:r+parseInt(e.duration)}})),s=n.filter((e=>{const n=e+t;return!r.some((t=>e<t.end&&n>t.start))}));return console.log(e,"- slots disponible :",s),s}(n,t);return 0===r.length})).map((([e])=>e)),a=[],c=new Date;for(let e=0;e<30;e++){const t=new Date(c);t.setDate(c.getDate()+e),0===t.getDay()&&a.push(t.toISOString().split("T")[0])}const l=Array.from(new Set([...i,...a]));p(l),r?.(l)}catch(e){console.error("Erreur lors de la récupération des dates désactivées:",e)}})()}),[]),(0,n.useEffect)((()=>{u(function(e){const t=[];for(let n=0;n<7;n++){const r=new Date(e);r.setDate(r.getDate()+n),t.push(r)}return t}(o))}),[o]),(0,n.useEffect)((()=>{const t=a.toISOString().split("T")[0];e(t)}),[]),(0,s.jsxs)("div",{className:"week-selector",children:[(0,s.jsx)("button",{onClick:()=>i(l(o,-7)),disabled:m,style:{opacity:m?.3:1,cursor:m?"not-allowed":"pointer"},title:m?"Impossible de revenir avant cette semaine":"Semaine précédente",children:"<"}),(0,s.jsx)("div",{className:"week-days",children:d.map((t=>{const n=t.getDate(),r=a?.toDateString()===t.toDateString(),o=0===t.getDay(),i=t.toISOString().split("T")[0],l=o||h.includes(i);return(0,s.jsx)("button",{disabled:l,className:`day-btn ${r?"selected":""} ${l?"disabled":""}`,onClick:()=>(t=>{if(0===t.getDay())return;c(t);const n=t.toISOString().split("T")[0];e(n)})(t),title:l?"Jour indisponible":"",children:n},i)}))}),(0,s.jsx)("button",{onClick:()=>i(l(o,7)),children:">"})]})}function l(e,t){const n=new Date(e);return n.setDate(n.getDate()+t),n}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("youbookpro-booking-root");e&&(0,r.H)(e).render((0,s.jsx)(o,{}))}))})();